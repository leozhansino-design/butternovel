================================================================================
                   BUTTERNOVEL API 安全分析 - 问题汇总
================================================================================

分析范围: 50+ API routes 和关键库文件
分析日期: 2025-11-15
总体风险评级: 🔴 HIGH (需要立即修复)

================================================================================
                        高风险问题 (需立即修复)
================================================================================

[HIGH #1] Admin 密码硬编码在代码中
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/admin/login/route.ts (第 6-14 行)
问题: ADMIN_ACCOUNTS 数组中硬编码了 bcrypt hash 密码
      如果代码仓库泄露，攻击者可直接获得 Admin 账户
      hash 对应的密码为已知值: mySecretPassword123
影响: 完全 Admin 账户接管
修复: 将 admin 账户迁移到数据库，存储加密的密码
     使用环境变量存储密码哈希值

[HIGH #2] Admin API 返回敏感的 OAuth IDs
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/admin/users/[id]/route.ts (第 126-127 行)
问题: 返回 googleId 和 facebookId 字段
      这些字段不应该被暴露
影响: 用户隐私泄露
修复: 移除 googleId/facebookId 字段返回
      仅返回 authMethod: 'google' | 'facebook' | 'email'

[HIGH #3] 公开 API 不检查用户隐私设置
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/novels/[id]/ratings/route.ts (第 64-71 行)
问题: 获取小说评分时返回用户信息，未检查 libraryPrivacy
      可能在用户不知情的情况下暴露用户信息
影响: GDPR/隐私合规性问题
修复: 检查用户隐私设置后再返回用户信息
      如果是 PRIVATE，返回 Anonymous

[HIGH #4] 缺少 Rate Limiting
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: 所有 API routes
问题: 没有实现 rate limiting
      可被暴力攻击: 登录、评论、评分、注册等
影响: 拒绝服务（DoS）、暴力破解
修复: 使用 @vercel/ratelimit 或 redis 实现


================================================================================
                      中风险问题 (应在 1-2 周内修复)
================================================================================

[MEDIUM #5] ADMIN_JWT_SECRET 默认值不安全
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/lib/admin-auth.ts (第 13-14 行)
问题: 硬编码的默认 JWT secret:
      'butternovel-super-secret-key-min-32-characters-long-change-in-production'
      如果环境变量未设置，会使用这个已知密钥
影响: Admin JWT 可被伪造
修复: 强制要求 ADMIN_JWT_SECRET 环境变量
      在生产环境中如果未设置则抛出错误

[MEDIUM #6] 排序参数未验证
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/admin/users/route.ts (第 26-27, 60-62)
问题: sortBy 和 sortOrder 参数未被验证
      直接用于 Prisma orderBy，可能导致数据库错误
影响: 潜在的信息泄露（错误消息）或 DoS
修复: 添加白名单验证:
      const ALLOWED_FIELDS = ['createdAt', 'email', 'name', 'updatedAt']
      if (!ALLOWED_FIELDS.includes(sortBy)) return error

[MEDIUM #7] 搜索参数未限制
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/admin/novels/route.ts (第 205-216)
问题: search 参数没有长度限制
      空字符串搜索会匹配所有记录
      没有搜索频率限制
影响: 信息泄露、性能问题
修复: search.length <= 50
      如果 search 为空则不添加 OR 条件
      考虑添加搜索频率限制

[MEDIUM #8] 验证 Schema 不一致
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/paragraph-comments/route.ts (第 83-87)
       vs /src/lib/validators.ts (第 222)
问题: 评论长度限制定义不一致:
      API 中: 1000 字符
      validators.ts: 500 字符
影响: 绕过验证、数据不一致
修复: 统一使用 Zod schema:
      commentSchema = z.object({
        content: z.string().max(WORD_LIMITS.COMMENT_MAX)
      })

[MEDIUM #9] Base64 图片验证不完整
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/paragraph-comments/route.ts (第 94-106)
问题: Base64 大小计算使用粗略估算
      没有验证 Base64 格式有效性
      没有验证实际文件类型
影响: 可能上传超大文件、文件类型检查绕过
修复: 使用改进的 validateBase64Image:
      1. 检查 data:image/* 前缀
      2. 正确计算大小: (base64Content * 3) / 4
      3. 实际验证图片内容


================================================================================
                        低风险问题 (可后期改进)
================================================================================

[LOW #10] 某些 API 错误信息过详细
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/admin/novels/[id]/route.ts (第 50-54)
问题: catch 块直接返回 error.message
影响: 可能泄露内部实现细节
修复: 使用统一的错误处理，隐藏生产环境错误

[LOW #11] 缺少 CORS 配置
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: 全局配置
问题: 没有显式的 CORS 配置
影响: 跨域请求可能被滥用
修复: 配置 CORS middleware，限制允许的来源

[LOW #12] 缺少 CSP (Content Security Policy) Headers
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: 全局配置
问题: 没有配置 CSP headers
影响: XSS 攻击防护不完整
修复: 在 next.config.ts 或 middleware 中配置 CSP

[LOW #13] Admin API 缺少细粒度权限检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
位置: /src/app/api/admin/stats/route.ts
问题: 所有 admin 操作都使用相同的 withAdminAuth
      没有区分 SUPER_ADMIN 和 ADMIN 角色
影响: 权限模型不够精细
修复: 使用 withAdminRole 进行细粒度控制


================================================================================
                           优势项 (保持现有)
================================================================================

✅ Admin 中间件实现良好 (withAdminAuth, withAdminRole)
✅ 用户操作权限验证正确 (评论删除权限检查)
✅ Zod Schema 验证覆盖关键操作
✅ 密码正确哈希存储 (bcrypt)
✅ 使用 Prisma ORM 防止 SQL 注入
✅ 大多数 API 正确使用 select 限制返回字段
✅ 统一的错误处理函数存在 (api-error-handler.ts)
✅ 文件上传有基本验证 (类型、大小)
✅ 使用第三方服务 Cloudinary 处理文件


================================================================================
                         修复时间表与优先级
================================================================================

🔴 立即修复 (本周):
   - [HIGH #1] Admin 密码 - 2 小时
   - [HIGH #2] OAuth IDs 泄露 - 1 小时
   - [HIGH #3] 隐私检查 - 2 小时
   总计: 5 小时

🟡 高优先级 (1-2 周):
   - [HIGH #4] Rate Limiting - 4 小时
   - [MEDIUM #5] JWT Secret - 1 小时
   - [MEDIUM #6] 排序验证 - 1 小时
   - [MEDIUM #7] 搜索限制 - 1 小时
   - [MEDIUM #8] Schema 一致 - 2 小时
   总计: 9 小时

🟢 中期改进 (1-2 个月):
   - [MEDIUM #9] Base64 验证 - 1 小时
   - [LOW #10-13] 其他改进 - 6 小时
   总计: 7 小时

总工作量: 21 小时 (~3 个工程师日)


================================================================================
                            测试检查清单
================================================================================

权限测试:
  [ ] 普通用户尝试访问 /api/admin/* - 应返回 401
  [ ] 普通用户尝试删除他人的评论 - 应返回 403
  [ ] 编辑他人的小说 - 应返回 403
  [ ] 过期 JWT token - 应返回 401

输入验证测试:
  [ ] sortBy=unknown_field - 应返回 400
  [ ] search=超级超级超级长字符串... (>500 chars) - 应返回 400
  [ ] 无效的 Base64 图片 - 应返回 400
  [ ] 超大文件上传 (>10MB) - 应返回 400

安全测试:
  [ ] 暴力登录尝试 (100 次/分钟) - 应被限流
  [ ] 检查 API 响应中的敏感数据泄露
  [ ] 检查错误消息是否泄露内部信息
  [ ] 检查 JWT payload 中是否包含密码

密码相关:
  [ ] 确认密码仅以 bcrypt hash 存储
  [ ] 确认 API 响应不返回 password 字段
  [ ] 确认 session 不包含 password


================================================================================
                         建议的安全改进方案
================================================================================

短期 (1-2 周):
1. 修复所有 HIGH 问题
2. 实现基础 Rate Limiting
3. 添加参数验证

中期 (1-2 个月):
1. 实现更复杂的 Rate Limiting 策略
2. 添加审计日志
3. 实现 API 密钥管理
4. 配置 CSP headers
5. 严格 CORS 配置

长期 (3-6 个月):
1. 实现 API 版本管理
2. 添加 OpenAPI/Swagger 文档
3. 定期安全审计
4. 实现 OAuth2 和 OIDC
5. 添加 Web 应用防火墙 (WAF) 规则

