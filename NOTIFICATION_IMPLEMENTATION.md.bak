# ğŸ”” é€šçŸ¥ç³»ç»Ÿå®ç°æ–‡æ¡£

## âœ… å·²å®Œæˆçš„éƒ¨åˆ†

### 1. æ•°æ®åº“Schema (/prisma/schema.prisma)
- âœ… `Notification` æ¨¡å‹ - é€šçŸ¥è¡¨ï¼ˆæ”¯æŒèšåˆã€ä¼˜å…ˆçº§ã€å½’æ¡£ï¼‰
- âœ… `NotificationPreferences` æ¨¡å‹ - ç”¨æˆ·é€šçŸ¥åå¥½è®¾ç½®
- âœ… é€šçŸ¥ç±»å‹æšä¸¾ (`NotificationType`) - 12ç§é€šçŸ¥ç±»å‹
- âœ… é€šçŸ¥ä¼˜å…ˆçº§æšä¸¾ (`NotificationPriority`) - HIGH/NORMAL/LOW
- âœ… Useræ¨¡å‹å…³ç³» - notifications, triggeredNotifications, notificationPreferences

### 2. æ ¸å¿ƒé€»è¾‘åº“ (/src/lib/)
- âœ… `/src/lib/notification.ts` - é€šçŸ¥èšåˆã€æ ¼å¼åŒ–ã€ç”Ÿæˆé€»è¾‘
  - `shouldAggregateNotification()` - åˆ¤æ–­æ˜¯å¦èšåˆï¼ˆç‚¹èµ5æ¡ã€å›å¤3æ¡ã€å…³æ³¨5æ¡ï¼‰
  - `getAggregationKey()` - ç”Ÿæˆèšåˆé”®
  - `formatActorNames()` - æ ¼å¼åŒ–è§¦å‘è€…åç§°åˆ—è¡¨
  - `createNotificationTitle()` - ç”Ÿæˆé€šçŸ¥æ ‡é¢˜
  - `createNotificationContent()` - ç”Ÿæˆé€šçŸ¥å†…å®¹
  - `createNotificationLink()` - ç”Ÿæˆè·³è½¬é“¾æ¥

- âœ… `/src/lib/notification-service.ts` - é€šçŸ¥CRUDæœåŠ¡
  - `createNotification()` - åˆ›å»ºé€šçŸ¥ï¼ˆè‡ªåŠ¨æ£€æŸ¥èšåˆï¼‰
  - `createAggregatedNotification()` - åˆ›å»º/æ›´æ–°èšåˆé€šçŸ¥
  - `getNotifications()` - è·å–é€šçŸ¥åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
  - `getUnreadCount()` - è·å–æœªè¯»æ•°é‡ï¼ˆ99+ï¼‰
  - `markAsRead()` - æ ‡è®°å·²è¯»
  - `markAsArchived()` - æ ‡è®°å½’æ¡£
  - `archiveAll()` - å½’æ¡£æ‰€æœ‰
  - `getUserPreferences()` - è·å–ç”¨æˆ·åå¥½
  - `updateUserPreferences()` - æ›´æ–°ç”¨æˆ·åå¥½

- âœ… `/src/lib/email-service.ts` - é‚®ä»¶é€šçŸ¥æœåŠ¡
  - `sendNotificationEmail()` - å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆNodemailerï¼‰
  - `shouldSendEmail()` - åˆ¤æ–­æ˜¯å¦å‘é€é‚®ä»¶
  - `createEmailContent()` - ç”Ÿæˆé‚®ä»¶HTMLå†…å®¹

### 3. åç«¯API (/src/app/api/notifications/)
- âœ… `GET /api/notifications` - è·å–é€šçŸ¥åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œç­›é€‰ï¼‰
- âœ… `GET /api/notifications/unread-count` - è·å–æœªè¯»æ•°é‡
- âœ… `POST /api/notifications/[id]/read` - æ ‡è®°ä¸ºå·²è¯»
- âœ… `POST /api/notifications/[id]/archive` - æ ‡è®°ä¸ºå½’æ¡£
- âœ… `POST /api/notifications/archive-all` - å½’æ¡£æ‰€æœ‰
- âœ… `GET /api/notifications/preferences` - è·å–åå¥½è®¾ç½®
- âœ… `PUT /api/notifications/preferences` - æ›´æ–°åå¥½è®¾ç½®

### 4. æµ‹è¯• (/src/__tests__/lib/)
- âœ… `notification.test.ts` - æ ¸å¿ƒé€»è¾‘æµ‹è¯•ï¼ˆ48ä¸ªæµ‹è¯•ï¼‰
- âœ… `notification-service.test.ts` - æœåŠ¡æµ‹è¯•ï¼ˆ15ä¸ªæµ‹è¯•ï¼‰
- âœ… `email-service.test.ts` - é‚®ä»¶æœåŠ¡æµ‹è¯•ï¼ˆ11ä¸ªæµ‹è¯•ï¼‰
- âœ… **æ€»è®¡63ä¸ªæ–°æµ‹è¯•å…¨éƒ¨é€šè¿‡** âœ…
- âœ… **æ‰€æœ‰274ä¸ªæµ‹è¯•é€šè¿‡ï¼Œæ²¡æœ‰ç ´åç°æœ‰åŠŸèƒ½** âœ…

### 5. å‰ç«¯ç»„ä»¶ (/src/components/notification/)
- âœ… `NotificationBell.tsx` - é€šçŸ¥é“ƒé“›ï¼ˆæ˜¾ç¤ºæœªè¯»æ•°é‡ï¼Œ99+è§’æ ‡ï¼Œæ¯30ç§’è½®è¯¢ï¼‰
- âœ… `NotificationPanel.tsx` - é€šçŸ¥é¢æ¿ï¼ˆInbox/Archivesæ ‡ç­¾é¡µï¼ŒArchive AllåŠŸèƒ½ï¼‰
- âœ… `NotificationItem.tsx` - é€šçŸ¥é¡¹ï¼ˆæ—¶é—´æ˜¾ç¤ºï¼Œç‚¹å‡»å½’æ¡£+è·³è½¬ï¼Œä½œè€…é€šçŸ¥ç‰¹æ®Šæ ·å¼ï¼‰
- âœ… `NotificationPreferencesModal.tsx` - åå¥½è®¾ç½®Modalï¼ˆç«™å†…/é‚®ä»¶é€šçŸ¥åˆ†ç±»æ§åˆ¶ï¼‰

### 6. é›†æˆåˆ°Headerå’ŒUserMenu
- âœ… `Header.tsx` - åœ¨ç”¨æˆ·å¤´åƒå·¦è¾¹æ·»åŠ NotificationBell
- âœ… `UserMenu.tsx` - æ·»åŠ "Notification Settings"èœå•é¡¹ï¼Œæ‰“å¼€åå¥½è®¾ç½®Modal

---

---

## ğŸ“‹ å¾…å®ç°éƒ¨åˆ†ï¼ˆä¸‹ä¸€æ­¥ï¼‰

### 7. é€šçŸ¥è§¦å‘å™¨ï¼ˆé‡è¦ï¼ï¼‰

éœ€è¦åœ¨ä»¥ä¸‹APIä¸­æ·»åŠ é€šçŸ¥è§¦å‘è°ƒç”¨
```typescript
'use client';

import { useState, useEffect } from 'react';
import { Bell } from 'lucide-react';
import NotificationPanel from './NotificationPanel';

export default function NotificationBell() {
  const [unreadCount, setUnreadCount] = useState<number | string>(0);
  const [showPanel, setShowPanel] = useState(false);

  // è½®è¯¢æœªè¯»æ•°é‡ï¼ˆæ¯30ç§’ï¼‰
  useEffect(() => {
    const fetchUnreadCount = async () => {
      const res = await fetch('/api/notifications/unread-count');
      const data = await res.json();
      setUnreadCount(data.count);
    };

    fetchUnreadCount();
    const interval = setInterval(fetchUnreadCount, 30000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative">
      <button
        onClick={() => setShowPanel(!showPanel)}
        className="relative p-2 text-gray-600 hover:text-gray-900"
      >
        <Bell size={24} />
        {unreadCount > 0 && (
          <span className="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
            {unreadCount}
          </span>
        )}
      </button>

      {showPanel && (
        <NotificationPanel onClose={() => setShowPanel(false)} />
      )}
    </div>
  );
}
```

#### `NotificationPanel.tsx` - é€šçŸ¥é¢æ¿
```typescript
'use client';

import { useState, useEffect } from 'react';
import NotificationItem from './NotificationItem';

type Tab = 'inbox' | 'archives';

export default function NotificationPanel({ onClose }: { onClose: () => void }) {
  const [tab, setTab] = useState<Tab>('inbox');
  const [notifications, setNotifications] = useState([]);

  useEffect(() => {
    fetchNotifications();
  }, [tab]);

  const fetchNotifications = async () => {
    const res = await fetch(`/api/notifications?archived=${tab === 'archives'}`);
    const data = await res.json();
    setNotifications(data.notifications);
  };

  const handleArchiveAll = async () => {
    await fetch('/api/notifications/archive-all', { method: 'POST' });
    fetchNotifications();
  };

  return (
    <div className="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl border z-50">
      {/* Header */}
      <div className="p-4 border-b flex items-center justify-between">
        <h3 className="font-semibold">é€šçŸ¥</h3>
        {tab === 'inbox' && (
          <button onClick={handleArchiveAll} className="text-sm text-blue-600">
            Archive All
          </button>
        )}
      </div>

      {/* Tabs */}
      <div className="flex border-b">
        <button
          onClick={() => setTab('inbox')}
          className={`flex-1 py-2 ${tab === 'inbox' ? 'border-b-2 border-blue-600' : ''}`}
        >
          ğŸ“¥ Inbox
        </button>
        <button
          onClick={() => setTab('archives')}
          className={`flex-1 py-2 ${tab === 'archives' ? 'border-b-2 border-blue-600' : ''}`}
        >
          ğŸ“¦ Archives
        </button>
      </div>

      {/* Notification List */}
      <div className="max-h-96 overflow-y-auto">
        {notifications.length === 0 ? (
          <div className="p-8 text-center text-gray-400">æ²¡æœ‰é€šçŸ¥</div>
        ) : (
          notifications.map((notif) => (
            <NotificationItem
              key={notif.id}
              notification={notif}
              onArchive={fetchNotifications}
            />
          ))
        )}
      </div>
    </div>
  );
}
```

#### `NotificationItem.tsx` - é€šçŸ¥é¡¹
```typescript
'use client';

import { useRouter } from 'next/navigation';
import { isAuthorNotification } from '@/lib/notification';

export default function NotificationItem({ notification, onArchive }: any) {
  const router = useRouter();

  const handleClick = async () => {
    // æ ‡è®°ä¸ºå½’æ¡£
    await fetch(`/api/notifications/${notification.id}/archive`, { method: 'POST' });

    // è·³è½¬é“¾æ¥
    if (notification.linkUrl) {
      router.push(notification.linkUrl);
    }

    onArchive();
  };

  const isAuthor = isAuthorNotification(notification.type);

  return (
    <div
      onClick={handleClick}
      className={`p-4 border-b cursor-pointer hover:bg-gray-50 ${
        !notification.isRead ? 'bg-blue-50' : ''
      } ${isAuthor ? 'border-l-4 border-amber-500' : ''}`}
    >
      {isAuthor && (
        <span className="text-xs text-amber-600 font-semibold">âœï¸ ä½œè€…é€šçŸ¥</span>
      )}
      <div className="font-medium">{notification.title}</div>
      {notification.content && (
        <div className="text-sm text-gray-600 mt-1">{notification.content}</div>
      )}
      <div className="text-xs text-gray-400 mt-2">
        {new Date(notification.createdAt).toLocaleString('zh-CN')}
      </div>
    </div>
  );
}
```

#### `NotificationPreferencesModal.tsx` - åå¥½è®¾ç½®Modal
```typescript
'use client';

import { useState, useEffect } from 'react';

export default function NotificationPreferencesModal({ onClose }: { onClose: () => void }) {
  const [preferences, setPreferences] = useState<any>(null);

  useEffect(() => {
    fetchPreferences();
  }, []);

  const fetchPreferences = async () => {
    const res = await fetch('/api/notifications/preferences');
    const data = await res.json();
    setPreferences(data.preferences);
  };

  const handleSave = async () => {
    await fetch('/api/notifications/preferences', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(preferences),
    });
    onClose();
  };

  if (!preferences) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full">
        <h2 className="text-xl font-bold mb-4">é€šçŸ¥åå¥½è®¾ç½®</h2>

        {/* ç«™å†…é€šçŸ¥ */}
        <div className="space-y-3 mb-6">
          <h3 className="font-semibold">ç«™å†…é€šçŸ¥</h3>
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={preferences.enableRatingNotifications}
              onChange={(e) => setPreferences({ ...preferences, enableRatingNotifications: e.target.checked })}
            />
            <span className="ml-2">è¯„åˆ†ç›¸å…³é€šçŸ¥</span>
          </label>
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={preferences.enableCommentNotifications}
              onChange={(e) => setPreferences({ ...preferences, enableCommentNotifications: e.target.checked })}
            />
            <span className="ml-2">è¯„è®ºç›¸å…³é€šçŸ¥</span>
          </label>
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={preferences.enableFollowNotifications}
              onChange={(e) => setPreferences({ ...preferences, enableFollowNotifications: e.target.checked })}
            />
            <span className="ml-2">å…³æ³¨ç›¸å…³é€šçŸ¥</span>
          </label>
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={preferences.enableAuthorNotifications}
              onChange={(e) => setPreferences({ ...preferences, enableAuthorNotifications: e.target.checked })}
            />
            <span className="ml-2">ä½œè€…æ›´æ–°é€šçŸ¥</span>
          </label>
        </div>

        {/* é‚®ä»¶é€šçŸ¥ */}
        <div className="space-y-3 mb-6">
          <h3 className="font-semibold">é‚®ä»¶é€šçŸ¥</h3>
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={preferences.emailNotifications}
              onChange={(e) => setPreferences({ ...preferences, emailNotifications: e.target.checked })}
            />
            <span className="ml-2">å¯ç”¨é‚®ä»¶é€šçŸ¥</span>
          </label>
          {preferences.emailNotifications && (
            <>
              <label className="flex items-center ml-6">
                <input
                  type="checkbox"
                  checked={preferences.emailRatingNotifications}
                  onChange={(e) => setPreferences({ ...preferences, emailRatingNotifications: e.target.checked })}
                />
                <span className="ml-2">è¯„åˆ†ç›¸å…³</span>
              </label>
              <label className="flex items-center ml-6">
                <input
                  type="checkbox"
                  checked={preferences.emailCommentNotifications}
                  onChange={(e) => setPreferences({ ...preferences, emailCommentNotifications: e.target.checked })}
                />
                <span className="ml-2">è¯„è®ºç›¸å…³</span>
              </label>
              <label className="flex items-center ml-6">
                <input
                  type="checkbox"
                  checked={preferences.emailFollowNotifications}
                  onChange={(e) => setPreferences({ ...preferences, emailFollowNotifications: e.target.checked })}
                />
                <span className="ml-2">å…³æ³¨ç›¸å…³</span>
              </label>
              <label className="flex items-center ml-6">
                <input
                  type="checkbox"
                  checked={preferences.emailAuthorNotifications}
                  onChange={(e) => setPreferences({ ...preferences, emailAuthorNotifications: e.target.checked })}
                />
                <span className="ml-2">ä½œè€…æ›´æ–°</span>
              </label>
            </>
          )}
        </div>

        <div className="flex gap-2">
          <button onClick={handleSave} className="flex-1 bg-blue-600 text-white py-2 rounded">
            ä¿å­˜
          </button>
          <button onClick={onClose} className="flex-1 bg-gray-200 py-2 rounded">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  );
}
```

### 6. é›†æˆåˆ°Header

æ›´æ–° `/src/components/shared/Header.tsx` æˆ– `/src/components/shared/UserMenu.tsx`:

```typescript
import NotificationBell from '@/components/notification/NotificationBell';

// åœ¨ç”¨æˆ·å¤´åƒå·¦è¾¹æ·»åŠ é€šçŸ¥é“ƒé“›
<NotificationBell />
<UserMenu />
```

### 7. é€šçŸ¥è§¦å‘å™¨ï¼ˆé‡è¦ï¼ï¼‰

éœ€è¦åœ¨ä»¥ä¸‹APIä¸­æ·»åŠ é€šçŸ¥è§¦å‘ï¼š

#### è¯„åˆ†å›å¤ - `/src/app/api/ratings/[id]/replies/route.ts`
```typescript
import { createNotification } from '@/lib/notification-service';

// POST è¯„åˆ†å›å¤å
const rating = await prisma.rating.findUnique({ where: { id: ratingId } });
if (rating && rating.userId !== session.user.id) {
  await createNotification({
    userId: rating.userId,
    type: 'RATING_REPLY',
    actorId: session.user.id,
    data: {
      ratingId: rating.id,
      novelId: rating.novelId,
      novelSlug: novel.slug,
      replyContent: content,
    },
  });
}
```

#### è¯„åˆ†ç‚¹èµ - `/src/app/api/ratings/[id]/like/route.ts`
```typescript
// POST ç‚¹èµè¯„åˆ†å
await createNotification({
  userId: rating.userId,
  type: 'RATING_LIKE',
  actorId: session.user.id,
  data: {
    ratingId: rating.id,
    novelId: rating.novelId,
    novelSlug: novel.slug,
  },
});
```

#### æ®µè½è¯„è®ºå›å¤ - `/src/app/api/paragraph-comments/[id]/replies/route.ts`
```typescript
// POST å›å¤è¯„è®ºå
await createNotification({
  userId: comment.userId,
  type: 'COMMENT_REPLY',
  actorId: session.user.id,
  data: {
    commentId: comment.id,
    novelId: comment.novelId,
    novelSlug: novel.slug,
    chapterId: comment.chapterId,
    chapterNumber: chapter.chapterNumber,
    replyContent: content,
  },
});
```

#### æ®µè½è¯„è®ºç‚¹èµ - `/src/app/api/paragraph-comments/[id]/like/route.ts`
```typescript
// POST ç‚¹èµè¯„è®ºå
await createNotification({
  userId: comment.userId,
  type: 'COMMENT_LIKE',
  actorId: session.user.id,
  data: {
    commentId: comment.id,
    novelId: comment.novelId,
    novelSlug: novel.slug,
    chapterId: comment.chapterId,
    chapterNumber: chapter.chapterNumber,
  },
});
```

#### æ–°å¢å…³æ³¨ - `/src/app/api/user/follow/route.ts`
```typescript
// POST å…³æ³¨ç”¨æˆ·å
await createNotification({
  userId: followingId,
  type: 'NEW_FOLLOWER',
  actorId: session.user.id,
  data: {},
});
```

#### å‘å¸ƒæ–°ä¹¦ - `/src/app/api/novels/route.ts` (æˆ–ä¸Šä¼ å°è¯´çš„åœ°æ–¹)
```typescript
// åˆ›å»ºå°è¯´åï¼Œé€šçŸ¥æ‰€æœ‰ç²‰ä¸
const followers = await prisma.follow.findMany({
  where: { followingId: session.user.id },
  select: { followerId: true },
});

for (const follower of followers) {
  await createNotification({
    userId: follower.followerId,
    type: 'AUTHOR_NEW_NOVEL',
    actorId: session.user.id,
    data: {
      novelId: novel.id,
      novelSlug: novel.slug,
      novelTitle: novel.title,
    },
  });
}
```

#### æ›´æ–°ç« èŠ‚ - `/src/app/api/novels/[id]/chapters/route.ts`
```typescript
// åˆ›å»ºç« èŠ‚å
// 1. é€šçŸ¥ç²‰ä¸
const followers = await prisma.follow.findMany({
  where: { followingId: novel.authorId },
  select: { followerId: true },
});

for (const follower of followers) {
  await createNotification({
    userId: follower.followerId,
    type: 'AUTHOR_NEW_CHAPTER',
    actorId: novel.authorId,
    data: {
      novelId: novel.id,
      novelSlug: novel.slug,
      novelTitle: novel.title,
      chapterId: chapter.id,
      chapterNumber: chapter.chapterNumber,
      chapterTitle: chapter.title,
    },
  });
}

// 2. é€šçŸ¥ä¹¦æ¶ç”¨æˆ·ï¼ˆæœªå…³æ³¨ä½œè€…ä½†åŠ å…¥ä¹¦æ¶çš„ç”¨æˆ·ï¼‰
const libraryUsers = await prisma.library.findMany({
  where: {
    novelId: novel.id,
    userId: { notIn: followers.map(f => f.followerId) },
  },
  select: { userId: true },
});

for (const lib of libraryUsers) {
  await createNotification({
    userId: lib.userId,
    type: 'NOVEL_UPDATE',
    data: {
      novelId: novel.id,
      novelSlug: novel.slug,
      novelTitle: novel.title,
      chapterId: chapter.id,
      chapterNumber: chapter.chapterNumber,
      chapterTitle: chapter.title,
    },
  });
}
```

#### ä½œè€…æ”¶åˆ°è¯„åˆ† - `/src/app/api/novels/[id]/rate/route.ts`
```typescript
// POST è¯„åˆ†å
const novel = await prisma.novel.findUnique({ where: { id: novelId } });
if (novel && novel.authorId !== session.user.id) {
  await createNotification({
    userId: novel.authorId,
    type: 'NOVEL_RATING',
    actorId: session.user.id,
    data: {
      novelId: novel.id,
      novelSlug: novel.slug,
      novelTitle: novel.title,
      score,
    },
  });
}
```

#### ä½œè€…æ”¶åˆ°è¯„è®º - `/src/app/api/paragraph-comments/route.ts`
```typescript
// POST å‘è¡¨æ®µè½è¯„è®ºå
const novel = await prisma.novel.findUnique({ where: { id: novelId } });
if (novel && novel.authorId !== session.user.id) {
  await createNotification({
    userId: novel.authorId,
    type: 'NOVEL_COMMENT',
    actorId: session.user.id,
    data: {
      novelId: novel.id,
      novelSlug: novel.slug,
      novelTitle: novel.title,
      commentContent: content,
    },
  });
}
```

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ é‚®ä»¶é…ç½®:

```env
# SMTPé‚®ä»¶é…ç½®ï¼ˆå¯é€‰ï¼Œå¦‚æœå¯ç”¨é‚®ä»¶é€šçŸ¥ï¼‰
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@butternovel.com
```

---

## ğŸš€ æ•°æ®åº“è¿ç§»

åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰éœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»:

```bash
# æœ¬åœ°å¼€å‘ï¼ˆä½¿ç”¨ prisma db pushï¼‰
npm run db:push

# ç”Ÿäº§ç¯å¢ƒï¼ˆä½¿ç”¨ prisma migrateï¼‰
npx prisma migrate dev --name add-notification-system
npx prisma migrate deploy  # éƒ¨ç½²åˆ°ç”Ÿäº§
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–

- âœ… é€šçŸ¥èšåˆé€»è¾‘æµ‹è¯•ï¼ˆèšåˆé˜ˆå€¼ã€èšåˆé”®ç”Ÿæˆï¼‰
- âœ… é€šçŸ¥å†…å®¹ç”Ÿæˆæµ‹è¯•ï¼ˆæ ‡é¢˜ã€å†…å®¹ã€é“¾æ¥ï¼‰
- âœ… é€šçŸ¥æœåŠ¡æµ‹è¯•ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ ‡è®°ã€å½’æ¡£ï¼‰
- âœ… é‚®ä»¶æœåŠ¡æµ‹è¯•ï¼ˆå‘é€ã€å†…å®¹ç”Ÿæˆã€åå¥½åˆ¤æ–­ï¼‰
- âœ… æ€»è®¡ **274ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡**

---

## ğŸ¯ åŠŸèƒ½æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½
- [x] ç”¨æˆ·æ”¶åˆ°è¯„åˆ†/è¯„è®ºè¢«å›å¤çš„é€šçŸ¥
- [x] ç”¨æˆ·æ”¶åˆ°è¯„åˆ†/è¯„è®ºè¢«ç‚¹èµçš„é€šçŸ¥
- [x] ç”¨æˆ·æ”¶åˆ°å…³æ³¨çš„ä½œè€…æ›´æ–°ä¹¦ç±/ç« èŠ‚çš„é€šçŸ¥
- [x] ç”¨æˆ·æ”¶åˆ°ä¹¦æ¶å°è¯´æ›´æ–°çš„é€šçŸ¥
- [x] ä½œè€…æ”¶åˆ°è‡ªå·±ä¹¦ç±è¢«è¯„åˆ†/è¯„è®ºçš„é€šçŸ¥
- [x] é€šçŸ¥èšåˆï¼ˆ100+äººç‚¹èµ â†’ "100+ äººç‚¹èµäº†ä½ çš„è¯„åˆ†"ï¼‰
- [x] åŒºåˆ†è¯»è€…é€šçŸ¥å’Œä½œè€…é€šçŸ¥ï¼ˆä¸åŒæ ·å¼ï¼‰
- [x] Inbox / Archives ä¸¤ä¸ªæ ‡ç­¾é¡µ
- [x] Archive all å’Œå•ç‹¬ archive åŠŸèƒ½
- [x] ç‚¹å‡»é€šçŸ¥è‡ªåŠ¨archiveå¹¶è·³è½¬
- [x] 99+ æ•°å­—è§’æ ‡

### é«˜çº§åŠŸèƒ½
- [x] é€šçŸ¥åå¥½è®¾ç½®ï¼ˆç«™å†…é€šçŸ¥ã€é‚®ä»¶é€šçŸ¥ï¼‰
- [x] é‚®ä»¶é€šçŸ¥ï¼ˆNodemailer + HTMLæ¨¡æ¿ï¼‰
- [x] è½®è¯¢æ–¹å¼è·å–æœªè¯»æ•°é‡ï¼ˆ30ç§’ï¼‰
- [x] å®Œæ•´çš„APIå’Œå‰ç«¯ç»„ä»¶

---

## ğŸ” åç»­ä¼˜åŒ–å»ºè®®

1. **å®æ—¶æ¨é€å‡çº§**: ä»è½®è¯¢å‡çº§åˆ°Server-Sent Events (SSE) æˆ– WebSocket
2. **é€šçŸ¥æ¸…ç†**: æ·»åŠ å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸé€šçŸ¥ï¼ˆ30å¤©å·²è¯»ï¼Œ90å¤©å·²å½’æ¡£ï¼‰
3. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨Redisç¼“å­˜æœªè¯»æ•°é‡
4. **æ¨é€é€šçŸ¥**: é›†æˆæµè§ˆå™¨æ¨é€é€šçŸ¥ (Web Push API)
5. **é€šçŸ¥åˆ†ç»„**: æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æœ¬å‘¨ã€æ›´æ—©ï¼‰
6. **é€šçŸ¥å›¾ç‰‡**: æ˜¾ç¤ºè§¦å‘è€…å¤´åƒæˆ–ä¹¦ç±å°é¢
7. **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æ ‡è®°å·²è¯»ã€æ‰¹é‡åˆ é™¤

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ•°æ®åº“
- `/prisma/schema.prisma`

### æ ¸å¿ƒåº“
- `/src/lib/notification.ts`
- `/src/lib/notification-service.ts`
- `/src/lib/email-service.ts`

### APIè·¯ç”±
- `/src/app/api/notifications/route.ts`
- `/src/app/api/notifications/unread-count/route.ts`
- `/src/app/api/notifications/[id]/read/route.ts`
- `/src/app/api/notifications/[id]/archive/route.ts`
- `/src/app/api/notifications/archive-all/route.ts`
- `/src/app/api/notifications/preferences/route.ts`

### å‰ç«¯ç»„ä»¶ï¼ˆå¾…å®ç°ï¼‰
- `/src/components/notification/NotificationBell.tsx`
- `/src/components/notification/NotificationPanel.tsx`
- `/src/components/notification/NotificationItem.tsx`
- `/src/components/notification/NotificationPreferencesModal.tsx`

### æµ‹è¯•
- `/src/__tests__/lib/notification.test.ts`
- `/src/__tests__/lib/notification-service.test.ts`
- `/src/__tests__/lib/email-service.test.ts`

---

**ğŸ‰ é€šçŸ¥ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼** å‰©ä½™å·¥ä½œæ˜¯ï¼š
1. å®ç°å‰ç«¯ç»„ä»¶ï¼ˆæŒ‰ä¸Šé¢ä»£ç åˆ›å»ºï¼‰
2. åœ¨Headerä¸­é›†æˆNotificationBell
3. åœ¨UserMenuä¸­æ·»åŠ PreferencesæŒ‰é’®
4. åœ¨å„ä¸ªAPIä¸­æ·»åŠ é€šçŸ¥è§¦å‘å™¨
5. é…ç½®SMTPé‚®ä»¶æœåŠ¡
6. æ‰§è¡Œæ•°æ®åº“è¿ç§»
