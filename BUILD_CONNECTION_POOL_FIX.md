# ğŸ”§ Build è¿æ¥æ± è¶…æ—¶é—®é¢˜ä¿®å¤

## âŒ é—®é¢˜

åœ¨ `npm run build` æ—¶é‡åˆ°é”™è¯¯ï¼š

```
Timed out fetching a new connection from the connection pool
(Current connection pool timeout: 10, connection limit: 5)
```

**åŸå› ï¼š**
- Next.js build æ—¶å°è¯•é¢„æ¸²æŸ“å¤§é‡ç« èŠ‚é¡µé¢ï¼ˆæœ€å¤š 5000 ä¸ªï¼‰
- Prisma Postgres è¿æ¥æ± é™åˆ¶ä¸º 5 ä¸ªè¿æ¥
- å¤§é‡å¹¶å‘è¯·æ±‚å¯¼è‡´è¿æ¥æ± è€—å°½

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. é™åˆ¶é™æ€ç”Ÿæˆçš„é¡µé¢æ•°é‡

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/app/novels/[slug]/chapters/[number]/page.tsx`

```typescript
// ğŸ”§ åªé¢„æ¸²æŸ“æœ€çƒ­é—¨çš„ 5 ä¸ªå°è¯´çš„å‰ 3 ç«  (å…± 15 é¡µ)
// å…¶ä»–é¡µé¢é€šè¿‡ dynamicParams = true æŒ‰éœ€ç”Ÿæˆ

export const dynamicParams = true  // å…è®¸åŠ¨æ€å‚æ•°

export async function generateStaticParams() {
  const novels = await prisma.novel.findMany({
    where: { isPublished: true, isBanned: false },
    select: {
      slug: true,
      chapters: {
        where: { isPublished: true },
        select: { chapterNumber: true },
        orderBy: { chapterNumber: 'asc' },
        take: 3  // âœ… åªé¢„æ¸²æŸ“å‰ 3 ç« 
      }
    },
    orderBy: { viewCount: 'desc' },
    take: 5  // âœ… åªé¢„æ¸²æŸ“æœ€çƒ­é—¨çš„ 5 ä¸ªå°è¯´
  })

  // ... ç”Ÿæˆå‚æ•°
}
```

**æ•ˆæœï¼š**
- âŒ ä¿®å¤å‰ï¼šæœ€å¤šé¢„æ¸²æŸ“ 100 Ã— 50 = 5000 ä¸ªé¡µé¢
- âœ… ä¿®å¤åï¼šåªé¢„æ¸²æŸ“ 5 Ã— 3 = 15 ä¸ªé¡µé¢
- âœ… å…¶ä»–é¡µé¢é¦–æ¬¡è®¿é—®æ—¶åŠ¨æ€ç”Ÿæˆï¼Œç„¶åç¼“å­˜ï¼ˆISRï¼‰

### 2. ä¼˜åŒ–è¿æ¥æ± é…ç½®

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/lib/prisma.ts`

```typescript
// ğŸ”§ Build æ—¶ä½¿ç”¨æ›´ä¿å®ˆçš„è¿æ¥æ± è®¾ç½®
const isBuildTime = process.env.NEXT_PHASE === 'phase-production-build'

databaseUrl.searchParams.set('connection_limit', isBuildTime ? '2' : '5')
databaseUrl.searchParams.set('pool_timeout', isBuildTime ? '30' : '10')
databaseUrl.searchParams.set('connect_timeout', '15')
```

**æ•ˆæœï¼š**
- âœ… Build æ—¶ï¼š2 ä¸ªè¿æ¥ï¼Œ30 ç§’è¶…æ—¶
- âœ… è¿è¡Œæ—¶ï¼š5 ä¸ªè¿æ¥ï¼Œ10 ç§’è¶…æ—¶
- âœ… é¿å… build æ—¶è¿æ¥æ± è€—å°½

### 3. å‡å°‘ Build æ—¥å¿—å¼€é”€

```typescript
log: isBuildTime
  ? ['error']  // Build æ—¶åªè®°å½•é”™è¯¯
  : process.env.NODE_ENV === 'development'
    ? ['query', 'error', 'warn']  // å¼€å‘æ—¶è¯¦ç»†æ—¥å¿—
    : ['error'],  // ç”Ÿäº§æ—¶åªè®°å½•é”™è¯¯
```

---

## ğŸ¯ å·¥ä½œåŸç†

### ä¿®å¤å‰

```
Build æ—¶:
â”œâ”€â”€ å°è¯•é¢„æ¸²æŸ“ 5000 ä¸ªç« èŠ‚é¡µé¢
â”œâ”€â”€ å¹¶å‘åˆ›å»ºå¤§é‡æ•°æ®åº“è¿æ¥
â”œâ”€â”€ è¿æ¥æ± é™åˆ¶: 5 ä¸ª
â””â”€â”€ âŒ è¿æ¥æ± è€—å°½ â†’ Build å¤±è´¥
```

### ä¿®å¤å

```
Build æ—¶:
â”œâ”€â”€ åªé¢„æ¸²æŸ“ 15 ä¸ªçƒ­é—¨ç« èŠ‚é¡µé¢
â”œâ”€â”€ ä½¿ç”¨ä¿å®ˆçš„è¿æ¥æ± é…ç½®ï¼ˆ2 ä¸ªè¿æ¥ï¼Œ30s è¶…æ—¶ï¼‰
â”œâ”€â”€ å…¶ä»–é¡µé¢æ ‡è®°ä¸º dynamicParams = true
â””â”€â”€ âœ… Build æˆåŠŸ

è¿è¡Œæ—¶:
â”œâ”€â”€ é¢„æ¸²æŸ“çš„ 15 é¡µ â†’ ç«‹å³è¿”å›ï¼ˆé™æ€ï¼‰
â”œâ”€â”€ å…¶ä»–é¡µé¢é¦–æ¬¡è®¿é—® â†’ åŠ¨æ€ç”Ÿæˆ â†’ ç¼“å­˜ï¼ˆISRï¼‰
â””â”€â”€ âœ… æ‰€æœ‰é¡µé¢éƒ½èƒ½æ­£å¸¸è®¿é—®
```

---

## ğŸ“Š æ€§èƒ½å½±å“

### é™æ€ç”Ÿæˆ vs åŠ¨æ€ç”Ÿæˆ

| é¡µé¢ç±»å‹ | ä¿®å¤å‰ | ä¿®å¤å | é¦–æ¬¡åŠ è½½é€Ÿåº¦ |
|---------|--------|--------|------------|
| **çƒ­é—¨ç« èŠ‚** (å‰15é¡µ) | é™æ€ | é™æ€ | âš¡ æå¿« (~50ms) |
| **å…¶ä»–ç« èŠ‚** | é™æ€ | åŠ¨æ€â†’ç¼“å­˜ | ğŸ”„ é¦–æ¬¡ç¨æ…¢ (~500ms)<br>åç»­æå¿« (~50ms) |

**æ€»ç»“ï¼š**
- âœ… çƒ­é—¨å†…å®¹ä¿æŒæœ€ä½³æ€§èƒ½
- âœ… å…¶ä»–å†…å®¹é¦–æ¬¡è®¿é—®åè‡ªåŠ¨ç¼“å­˜
- âœ… Build æ—¶é—´å¤§å¹…ç¼©çŸ­
- âœ… ä¸å†é‡åˆ°è¿æ¥æ± é—®é¢˜

---

## ğŸš€ éªŒè¯ä¿®å¤

### 1. æœ¬åœ°æµ‹è¯•

```bash
# 1. æ¸…ç†ç¼“å­˜
rm -rf .next

# 2. è¿è¡Œ build
npm run build

# åº”è¯¥çœ‹åˆ°:
# âœ… Collecting page data...
# âœ… Generating static pages (15/15)
# âœ… Build completed successfully!

# 3. å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
npm start

# 4. æµ‹è¯•é¡µé¢
# - çƒ­é—¨ç« èŠ‚åº”è¯¥ç«‹å³åŠ è½½
# - å…¶ä»–ç« èŠ‚é¦–æ¬¡è®¿é—®ä¼šç¨æ…¢ï¼Œä½†åç»­è®¿é—®å¾ˆå¿«
```

### 2. æ£€æŸ¥é¢„æ¸²æŸ“çš„é¡µé¢

```bash
# æŸ¥çœ‹ .next/server/app/novels/ ç›®å½•
# åº”è¯¥åªçœ‹åˆ° 15 ä¸ªé¢„æ¸²æŸ“çš„ HTML æ–‡ä»¶
find .next/server/app/novels -name "*.html" | wc -l
# è¾“å‡º: ~15
```

### 3. ç›‘æ§è¿æ¥æ± 

åœ¨å¼€å‘æ—¶æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
npm run dev

# åº”è¯¥çœ‹åˆ°:
# âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡
# âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ
# è¿æ¥æ± é…ç½®: limit=5, timeout=10s
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸å®Œå…¨ç¦ç”¨é™æ€ç”Ÿæˆï¼Ÿ

**A:** ä¿ç•™å°‘é‡é™æ€ç”Ÿæˆçš„çƒ­é—¨é¡µé¢å¯ä»¥ï¼š
- âš¡ æœ€ä½³çš„é¦–å±æ€§èƒ½ï¼ˆæ— æ•°æ®åº“æŸ¥è¯¢ï¼‰
- ğŸŒ æ›´å¥½çš„ SEOï¼ˆæœç´¢å¼•æ“ç›´æ¥æŠ“å–é™æ€ HTMLï¼‰
- ğŸ’° å‡å°‘è¿è¡Œæ—¶æ•°æ®åº“è¿æ¥ï¼ˆé™ä½æˆæœ¬ï¼‰

### Q2: dynamicParams = true æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** å®ƒå‘Šè¯‰ Next.jsï¼š
- âœ… å…è®¸è®¿é—®æœªåœ¨ `generateStaticParams` ä¸­å®šä¹‰çš„è·¯ç”±
- âœ… åŠ¨æ€ç”Ÿæˆè¿™äº›é¡µé¢
- âœ… ç”Ÿæˆåç¼“å­˜ï¼ˆé€šè¿‡ `revalidate` é…ç½®ï¼‰

### Q3: å¦‚æœç« èŠ‚é¡µé¢è®¿é—®å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A:** å¯ä»¥å¢åŠ é¢„æ¸²æŸ“çš„é¡µé¢æ•°é‡ï¼š

```typescript
// å¢åŠ åˆ° 10 ä¸ªå°è¯´çš„å‰ 5 ç«  (50 é¡µ)
export async function generateStaticParams() {
  const novels = await prisma.novel.findMany({
    // ...
    take: 10  // âœ… å¢åŠ å°è¯´æ•°é‡
  })
  // ...
  chapters: {
    take: 5  // âœ… å¢åŠ ç« èŠ‚æ•°é‡
  }
}
```

ä½†è¦æ³¨æ„ï¼š
- âš ï¸ ä¸è¦è¶…è¿‡ 100 é¡µï¼Œå¦åˆ™å¯èƒ½å†æ¬¡é‡åˆ°è¿æ¥æ± é—®é¢˜
- âš ï¸ Build æ—¶é—´ä¼šå¢åŠ 

### Q4: Vercel éƒ¨ç½²æ—¶ä¼šæ€æ ·ï¼Ÿ

**A:** Vercel è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡ï¼š
- âœ… `NEXT_PHASE` åœ¨ build æ—¶è‡ªåŠ¨è®¾ç½®
- âœ… è¿æ¥æ± é…ç½®è‡ªåŠ¨è°ƒæ•´
- âœ… ISR ç¼“å­˜è‡ªåŠ¨ç®¡ç†
- âœ… æ— éœ€é¢å¤–é…ç½®

---

## ğŸ“ æ€»ç»“

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
1. âœ… `src/app/novels/[slug]/chapters/[number]/page.tsx`
   - æ·»åŠ  `dynamicParams = true`
   - å‡å°‘ `generateStaticParams` ç”Ÿæˆçš„é¡µé¢æ•°ï¼ˆ5000 â†’ 15ï¼‰

2. âœ… `src/lib/prisma.ts`
   - Build æ—¶ä½¿ç”¨æ›´ä¿å®ˆçš„è¿æ¥æ± é…ç½®
   - å‡å°‘æ—¥å¿—å¼€é”€

**æ•ˆæœï¼š**
- âœ… Build ä¸å†å› è¿æ¥æ± è¶…æ—¶è€Œå¤±è´¥
- âœ… çƒ­é—¨é¡µé¢ä¿æŒæœ€ä½³æ€§èƒ½
- âœ… æ‰€æœ‰é¡µé¢éƒ½èƒ½æ­£å¸¸è®¿é—®
- âœ… è¿è¡Œæ—¶è¿æ¥æ± é…ç½®ä¿æŒé«˜æ•ˆ

**ç‰ˆæœ¬:** v1.0
**æ›´æ–°:** 2025-11-11
**çŠ¶æ€:** âœ… å·²ä¿®å¤å¹¶éªŒè¯
