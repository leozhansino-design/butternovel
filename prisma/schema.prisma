// prisma/schema.prisma
// ğŸ¦‹ ButterNovel - Complete Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ç”¨æˆ·ç³»ç»Ÿ
// ============================================

// ç”¨æˆ·è¡¨ï¼ˆè¯»è€… = ä½œè€…ï¼‰
model User {
  id       String  @id @default(cuid())
  email    String  @unique
  password String?

  // åŸºç¡€ä¿¡æ¯ï¼ˆå¯ä¿®æ”¹ï¼‰
  name   String? // æ˜¾ç¤ºåç§°
  avatar String? // å¤´åƒ URL
  bio    String? @db.Text // ä¸ªäººç®€ä»‹

  // OAuth
  googleId   String? @unique
  facebookId String? @unique

  // ä½œå®¶ä¿¡æ¯
  isWriter   Boolean @default(false) // æ˜¯å¦æ¿€æ´»ä½œå®¶æ¨¡å¼
  writerName String? // ç¬”åï¼ˆå¯é€‰ï¼‰
  writerBio  String? @db.Text // ä½œå®¶ç®€ä»‹

  // è´¦å·çŠ¶æ€
  isVerified Boolean @default(false)
  isActive   Boolean @default(true)
  isBanned   Boolean @default(false) // æ˜¯å¦è¢«å°ç¦

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  novels          Novel[]
  library         Library[]
  readingHistory  ReadingHistory[]
  likes           NovelLike[]
  chapterProgress ChapterProgress[]
  comments        Comment[]

  // ç¤¾åŒºåŠŸèƒ½ï¼ˆåæœŸï¼‰
  forumPosts   ForumPost[]
  forumReplies ForumReply[]
  helpedCount  Int         @default(0) // æ‹¯æ•‘äº†å¤šå°‘äººçš„ä¹¦è’

  @@index([email])
  @@index([isWriter])
}

// ============================================
// å†…å®¹ç³»ç»Ÿ
// ============================================

// åˆ†ç±»ï¼ˆGenreï¼‰
model Category {
  id    Int     @id @default(autoincrement())
  name  String  @unique
  slug  String  @unique
  icon  String?
  order Int     @default(0)

  novels Novel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

// å°è¯´è¡¨
model Novel {
  id         Int    @id @default(autoincrement())
  title      String
  slug       String @unique
  coverImage String
  blurb      String @db.Text // ç®€ä»‹

  // ä½œè€…
  authorId   String
  author     User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorName String @default("ButterNovel Official")

  // åˆ†ç±»
  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  // çŠ¶æ€
  status      NovelStatus @default(ONGOING)
  isPublished Boolean     @default(false)
  isDraft     Boolean     @default(true)

  // å®¡æ ¸ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
  isApproved Boolean @default(true) // æ˜¯å¦é€šè¿‡å®¡æ ¸
  reviewNote String? @db.Text // å®¡æ ¸å¤‡æ³¨

  // ç»Ÿè®¡
  totalChapters Int @default(0)
  wordCount     Int @default(0)
  viewCount     Int @default(0)
  likeCount     Int @default(0)
  commentCount  Int @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // å…³ç³»
  chapters       Chapter[]
  library        Library[]
  readingHistory ReadingHistory[]
  likes          NovelLike[]
  comments       Comment[]

  @@index([slug])
  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([isPublished])
  @@index([isApproved])
}

enum NovelStatus {
  ONGOING // è¿è½½ä¸­
  COMPLETED // å·²å®Œç»“
}

// ç« èŠ‚è¡¨
model Chapter {
  id            Int     @id @default(autoincrement())
  novelId       Int
  novel         Novel   @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapterNumber Int
  title         String
  content       String  @db.Text
  wordCount     Int     @default(0)
  isPublished   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  readingHistory  ReadingHistory[]
  chapterProgress ChapterProgress[]

  @@unique([novelId, chapterNumber])
  @@index([novelId])
}

// ============================================
// é˜…è¯»ç³»ç»Ÿ
// ============================================

// ä¹¦æ¶
model Library {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  novelId Int
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  addedAt DateTime @default(now())

  @@unique([userId, novelId])
  @@index([userId])
}

// é˜…è¯»å†å²ï¼ˆè®°å½•è¯»åˆ°ç¬¬å‡ ç« ï¼‰
model ReadingHistory {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  novelId   Int
  novel     Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapterId Int
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  lastReadAt DateTime @default(now())

  @@unique([userId, novelId])
  @@index([userId])
  @@index([lastReadAt])
}

// ç« èŠ‚é˜…è¯»è¿›åº¦
model ChapterProgress {
  id             String  @id @default(cuid())
  userId         String
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapterId      Int
  chapter        Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  scrollPosition Int     @default(0)
  percentage     Int     @default(0)
  isCompleted    Boolean @default(false)

  updatedAt DateTime @updatedAt

  @@unique([userId, chapterId])
}

// ============================================
// äº’åŠ¨ç³»ç»Ÿ
// ============================================

// ç‚¹èµ
model NovelLike {
  id        String  @id @default(cuid())
  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  guestId   String?
  ipAddress String?
  novelId   Int
  novel     Novel   @relation(fields: [novelId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, novelId])
  @@unique([guestId, novelId])
  @@index([ipAddress, createdAt])
}

// è¯„è®º
model Comment {
  id      String @id @default(cuid())
  content String @db.Text
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  novelId Int
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  // å®¡æ ¸
  isApproved Boolean @default(true)
  isHidden   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([novelId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// ç¤¾åŒºç³»ç»Ÿï¼ˆåæœŸï¼‰
// ============================================

// è®ºå›å¸–å­ï¼ˆä¹¦è’æ±‚åŠ©ï¼‰
model ForumPost {
  id      String        @id @default(cuid())
  title   String
  content String        @db.Text
  type    ForumPostType @default(HELP) // HELP=æ±‚ä¹¦, RECOMMEND=æ¨è
  userId  String
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ç»Ÿè®¡
  viewCount   Int     @default(0)
  replyCount  Int     @default(0)
  helpedCount Int     @default(0) // æ‹¯æ•‘äº†å¤šå°‘äºº
  isResolved  Boolean @default(false) // æ˜¯å¦è§£å†³
  isClosed    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  replies ForumReply[]

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

enum ForumPostType {
  HELP // æ±‚ä¹¦
  RECOMMEND // æ¨èä¹¦å•
  DISCUSSION // è®¨è®º
}

// è®ºå›å›å¤
model ForumReply {
  id      String @id @default(cuid())
  content String @db.Text
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId  String
  post    ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  // æ¨èçš„å°è¯´ï¼ˆå¯é€‰ï¼‰
  novelId Int?

  // äº’åŠ¨
  helpfulCount Int @default(0) // æœ‰å¸®åŠ©çš„ç¥¨æ•°

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([userId])
}

// ============================================
// ç®¡ç†ç³»ç»Ÿ
// ============================================

// ç®¡ç†å‘˜
model Admin {
  id       String    @id @default(cuid())
  email    String    @unique
  password String
  name     String
  role     AdminRole @default(MODERATOR)
  isActive Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

enum AdminRole {
  SUPER_ADMIN // è¶…çº§ç®¡ç†å‘˜
  ADMIN // ç®¡ç†å‘˜
  MODERATOR // å†…å®¹å®¡æ ¸å‘˜
}
