# ButterNovel 移动端开发计划

> Google Play & iOS App Store 上架完整指南

## 目录

1. [项目概述](#项目概述)
2. [技术选型](#技术选型)
3. [代码复用分析](#代码复用分析)
4. [分阶段开发计划](#分阶段开发计划)
5. [应用商店要求](#应用商店要求)
6. [时间线与成本](#时间线与成本)

---

## 项目概述

### 现有 Web 项目统计

| 项目 | 数量 |
|-----|------|
| API 端点 | 60+ 个 |
| React 组件 | 87 个 |
| Prisma 模型 | 20+ 个 |
| 工具函数 | 31 个文件 |

### 复用率预估

| 类别 | 复用率 | 说明 |
|------|--------|------|
| API 层 | 100% | 所有端点直接复用 |
| 业务逻辑 | 100% | 验证、计算、处理逻辑 |
| 类型定义 | 100% | TypeScript/Prisma 类型 |
| UI 组件 | 0% | 需用 React Native 重写 |
| 样式 | 10% | 设计 token 可复用 |

---

## 技术选型

### 推荐技术栈

```
框架层:
├── Expo SDK 52+              # 快速开发、OTA 更新
├── React Native 0.76+        # 核心框架
├── TypeScript 5.x            # ✅ 已有配置
└── Expo Router               # 文件系统路由

状态管理:
├── @tanstack/react-query     # 服务端状态 (API 调用)
├── zustand                   # 客户端状态
└── react-hook-form + zod     # ✅ 表单验证直接复用

UI 组件:
├── NativeWind                # Tailwind CSS for RN
├── react-native-reanimated   # 动画
├── lucide-react-native       # 图标
└── react-native-gesture-handler

存储:
├── @react-native-async-storage/async-storage  # 缓存
├── expo-secure-store         # Token 安全存储
└── expo-sqlite               # 离线数据 (可选)

认证:
├── expo-auth-session         # OAuth 2.0
└── expo-web-browser          # Web 登录流程

推送:
├── expo-notifications        # 本地+远程推送
└── Firebase Cloud Messaging  # FCM 后端
```

---

## 代码复用分析

### ✅ 直接复用 (无需修改)

#### 1. API 端点 - 60+ 个全部复用

```typescript
// 认证 API
POST /api/auth/register
POST /api/auth/[...nextauth]

// 小说 API
GET  /api/novels/[id]/first-chapter
POST /api/novels/[id]/rate
GET  /api/novels/[id]/ratings
GET  /api/novels/[id]/tags

// 书架 API
GET  /api/library
POST /api/library
DELETE /api/library
GET  /api/library/check

// 阅读 API
GET  /api/reading-history
POST /api/reading-history
GET  /api/reading-progress
POST /api/reading-progress
GET  /api/chapter-progress
POST /api/chapter-progress

// 用户 API
GET  /api/profile
PUT  /api/profile
POST /api/profile/avatar
GET  /api/user/[userId]
POST /api/user/follow

// 互动 API
GET  /api/paragraph-comments
POST /api/paragraph-comments
POST /api/paragraph-comments/[id]/like
GET  /api/ratings/[id]/replies

// 通知 API
GET  /api/notifications
GET  /api/notifications/unread-count
POST /api/notifications/[id]/read
GET  /api/notifications/preferences

// 搜索 API
GET  /api/search
GET  /api/search/suggestions
GET  /api/categories
GET  /api/tags/[slug]
GET  /api/tags/popular

// 作者 API
GET  /api/dashboard/stats
GET  /api/dashboard/novels
POST /api/admin/novels
POST /api/admin/chapters
```

#### 2. 验证逻辑 - `/src/lib/validators.ts`

```typescript
// 这些 Zod schema 在 React Native 完全兼容
export const novelCreateSchema = z.object({...})
export const chapterCreateSchema = z.object({...})
export const ratingSchema = z.object({...})
export const commentSchema = z.object({...})
export const profileUpdateSchema = z.object({...})
```

#### 3. 类型定义 - `/src/lib/prisma-types.ts`

```typescript
export type ContentRating = 'ALL_AGES' | 'TEEN_13' | 'MATURE_16' | 'EXPLICIT_18'
export type RightsType = 'ALL_RIGHTS_RESERVED' | 'CREATIVE_COMMONS'
export type ContributionType = 'RATING' | 'COMMENT' | ...
export type NotificationType = 'RATING_REPLY' | 'RATING_LIKE' | ...
export type NotificationPriority = 'HIGH' | 'NORMAL' | 'LOW'
```

#### 4. 工具函数 - `/src/lib/`

| 文件 | 功能 | 复用 |
|------|------|------|
| `format.ts` | 日期、数字格式化 | ✅ 100% |
| `utils.ts` | 通用工具函数 | ✅ 100% |
| `tags.ts` | 标签处理逻辑 | ✅ 100% |
| `pagination.ts` | 分页计算 | ✅ 100% |
| `metadata.ts` | 元数据处理 | ✅ 100% |
| `badge-system.ts` | 等级徽章逻辑 | ✅ 100% |
| `notification.ts` | 通知聚合逻辑 | ✅ 100% |

---

### ⚠️ 需要适配

#### 1. 认证存储

**Web 实现:**
```typescript
// NextAuth 使用 Cookies
cookies().set('next-auth.session-token', token)
```

**移动端实现:**
```typescript
// 使用 SecureStore
import * as SecureStore from 'expo-secure-store'
await SecureStore.setItemAsync('auth-token', token)
```

#### 2. OAuth 重定向

**Web 实现:**
```typescript
// 浏览器重定向
redirect('/api/auth/callback/google')
```

**移动端实现:**
```typescript
// Deep Linking
import * as AuthSession from 'expo-auth-session'
const redirectUri = AuthSession.makeRedirectUri({
  scheme: 'butternovel',
  path: 'auth/callback'
})
```

#### 3. 图片组件

**Web 实现:**
```tsx
import Image from 'next/image'
<Image src={url} width={300} height={400} />
```

**移动端实现:**
```tsx
import FastImage from 'react-native-fast-image'
<FastImage source={{ uri: url }} style={{ width: 300, height: 400 }} />
```

#### 4. 缓存策略

**Web 实现:**
```typescript
// Redis + ISR
import { redis } from '@/lib/redis'
await redis.get('home:featured')
```

**移动端实现:**
```typescript
// AsyncStorage + React Query
import AsyncStorage from '@react-native-async-storage/async-storage'
import { useQuery } from '@tanstack/react-query'

const { data } = useQuery({
  queryKey: ['featured'],
  queryFn: fetchFeatured,
  staleTime: 1000 * 60 * 5, // 5 分钟
})
```

---

### ❌ 需要重建

#### UI 组件 (87 个)

所有 React 组件需要用 React Native 重写:

| Web 组件 | 移动端组件 |
|----------|-----------|
| `Header.tsx` | `AppHeader.tsx` + Navigation |
| `BookCard.tsx` | `NovelCard.tsx` (RN) |
| `AuthModal.tsx` | `AuthScreen.tsx` |
| `NotificationPanel.tsx` | `NotificationsScreen.tsx` |
| `ChapterForm.tsx` | `ChapterEditor.tsx` (RN) |
| 等 87 个... | 需全部重写 |

#### 样式系统

| Web | 移动端 |
|-----|--------|
| Tailwind CSS | NativeWind 或 StyleSheet |
| `className="..."` | `style={styles.xxx}` |
| CSS Grid | Flexbox only |
| CSS Variables | Theme Context |

---

## 分阶段开发计划

### 第一阶段: 基础框架 (2 周)

#### 目标
- 可运行的 App 骨架
- 完成登录/注册流程
- API 层完全就绪

#### 新开发

| 功能 | 文件 | 工作量 |
|------|------|--------|
| Expo 项目初始化 | `/mobile/` | 0.5 天 |
| 导航架构 | `app/_layout.tsx` | 1 天 |
| 主题系统 | `lib/theme.ts` | 0.5 天 |
| 登录页面 | `app/auth/login.tsx` | 1 天 |
| 注册页面 | `app/auth/register.tsx` | 1 天 |
| Google OAuth | `lib/google-auth.ts` | 1 天 |
| Apple Sign In | `lib/apple-auth.ts` | 1 天 |
| Token 存储 | `lib/auth-storage.ts` | 0.5 天 |

#### 直接复用

| 功能 | 来源 |
|------|------|
| 验证 Schema | `validators.ts` → 注册/登录验证 |
| API 类型 | `prisma-types.ts` → 用户类型 |
| API 端点 | `/api/auth/*` → 认证接口 |

#### 交付物
```
mobile/
├── app/
│   ├── _layout.tsx          # 根布局 + 导航
│   ├── index.tsx            # 启动页
│   └── auth/
│       ├── login.tsx        # 登录
│       └── register.tsx     # 注册
├── components/
│   ├── ui/                  # 基础 UI 组件
│   └── forms/               # 表单组件
├── lib/
│   ├── api-client.ts        # API 客户端
│   ├── auth-storage.ts      # Token 存储
│   └── theme.ts             # 主题配置
└── hooks/
    └── useAuth.ts           # 认证 Hook
```

---

### 第二阶段: 核心阅读 (3 周)

#### 目标
- 完整的小说浏览体验
- 章节阅读器
- 搜索功能

#### 新开发

| 功能 | 文件 | 工作量 |
|------|------|--------|
| 首页 | `app/(tabs)/index.tsx` | 2 天 |
| 小说卡片组件 | `components/NovelCard.tsx` | 1 天 |
| 轮播组件 | `components/Carousel.tsx` | 1 天 |
| 分类列表 | `app/category/[slug].tsx` | 1 天 |
| 小说详情页 | `app/novel/[slug].tsx` | 2 天 |
| 章节列表 | `components/ChapterList.tsx` | 1 天 |
| **阅读器** | `app/reader/[chapter].tsx` | 3 天 |
| 阅读设置 | `components/ReaderSettings.tsx` | 1 天 |
| 搜索页面 | `app/search.tsx` | 1.5 天 |
| 搜索结果 | `components/SearchResults.tsx` | 1 天 |

#### 直接复用

| 功能 | 来源 |
|------|------|
| 搜索 API | `/api/search` |
| 分类 API | `/api/categories` |
| 标签 API | `/api/tags/*` |
| 小说数据 | 数据库直接查询 |
| 格式化函数 | `format.ts` |

#### 关键实现: 阅读器

```tsx
// app/reader/[chapter].tsx
import { ScrollView, Text, StyleSheet } from 'react-native'
import { useQuery } from '@tanstack/react-query'

export default function ReaderScreen({ route }) {
  const { chapterId } = route.params

  const { data: chapter } = useQuery({
    queryKey: ['chapter', chapterId],
    queryFn: () => fetchChapter(chapterId)
  })

  return (
    <ScrollView style={styles.container}>
      <Text style={styles.title}>{chapter.title}</Text>
      <Text style={styles.content}>{chapter.content}</Text>
    </ScrollView>
  )
}
```

---

### 第三阶段: 用户功能 (2 周)

#### 目标
- 书架管理
- 阅读历史
- 个人中心

#### 新开发

| 功能 | 文件 | 工作量 |
|------|------|--------|
| 书架页面 | `app/(tabs)/library.tsx` | 1.5 天 |
| 书架卡片 | `components/LibraryCard.tsx` | 0.5 天 |
| 阅读历史 | `app/history.tsx` | 1 天 |
| 个人中心 | `app/(tabs)/profile.tsx` | 1.5 天 |
| 编辑资料 | `app/profile/edit.tsx` | 1 天 |
| 头像上传 | `components/AvatarPicker.tsx` | 1 天 |
| 设置页面 | `app/settings.tsx` | 1 天 |
| 隐私设置 | `app/settings/privacy.tsx` | 0.5 天 |

#### 直接复用

| 功能 | 来源 |
|------|------|
| 书架 API | `/api/library` ✅ |
| 历史 API | `/api/reading-history` ✅ |
| 进度 API | `/api/reading-progress` ✅ |
| 资料 API | `/api/profile` ✅ |
| 头像上传 | `/api/profile/avatar` ✅ |
| 隐私 API | `/api/profile/privacy` ✅ |
| 验证逻辑 | `profileUpdateSchema` ✅ |

---

### 第四阶段: 互动功能 (2 周)

#### 目标
- 评分系统
- 评论系统
- 社交功能

#### 新开发

| 功能 | 文件 | 工作量 |
|------|------|--------|
| 评分组件 | `components/RatingStars.tsx` | 0.5 天 |
| 评分表单 | `components/RatingForm.tsx` | 1 天 |
| 评分列表 | `components/RatingList.tsx` | 1 天 |
| 评论面板 | `components/CommentPanel.tsx` | 1.5 天 |
| 回复组件 | `components/ReplyThread.tsx` | 1 天 |
| 关注按钮 | `components/FollowButton.tsx` | 0.5 天 |
| 作者页面 | `app/author/[id].tsx` | 1 天 |
| 粉丝列表 | `app/followers.tsx` | 0.5 天 |
| 关注列表 | `app/following.tsx` | 0.5 天 |

#### 直接复用

| 功能 | 来源 |
|------|------|
| 评分 API | `/api/novels/[id]/rate` ✅ |
| 评分列表 | `/api/novels/[id]/ratings` ✅ |
| 评论 API | `/api/paragraph-comments` ✅ |
| 点赞 API | `/api/paragraph-comments/[id]/like` ✅ |
| 关注 API | `/api/user/follow` ✅ |
| 验证逻辑 | `ratingSchema`, `commentSchema` ✅ |

---

### 第五阶段: 通知系统 (1 周)

#### 目标
- 应用内通知
- 推送通知
- 通知偏好

#### 新开发

| 功能 | 文件 | 工作量 |
|------|------|--------|
| 通知列表 | `app/notifications.tsx` | 1 天 |
| 通知卡片 | `components/NotificationCard.tsx` | 0.5 天 |
| 推送配置 | `lib/push-notifications.ts` | 1 天 |
| 通知偏好 | `app/settings/notifications.tsx` | 0.5 天 |
| 未读角标 | `components/NotificationBadge.tsx` | 0.5 天 |

#### 直接复用

| 功能 | 来源 |
|------|------|
| 通知 API | `/api/notifications` ✅ |
| 未读数 | `/api/notifications/unread-count` ✅ |
| 偏好 API | `/api/notifications/preferences` ✅ |
| 聚合逻辑 | `notification.ts` ✅ |

#### 推送通知架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Web API   │────▶│   FCM/APNs  │────▶│  Mobile App │
└─────────────┘     └─────────────┘     └─────────────┘
       │
       ▼
┌─────────────┐
│  需要新增:  │
│  推送触发器 │
└─────────────┘
```

---

### 第六阶段: 作者功能 (2 周)

#### 目标
- 作者仪表盘
- 小说管理
- 章节编辑

#### 新开发

| 功能 | 文件 | 工作量 |
|------|------|--------|
| 作者仪表盘 | `app/dashboard/index.tsx` | 1.5 天 |
| 数据图表 | `components/StatsChart.tsx` | 1 天 |
| 小说列表 | `app/dashboard/novels.tsx` | 1 天 |
| 创建小说 | `app/dashboard/novels/new.tsx` | 1.5 天 |
| 编辑小说 | `app/dashboard/novels/[id]/edit.tsx` | 1 天 |
| 章节列表 | `app/dashboard/novels/[id]/chapters.tsx` | 1 天 |
| 章节编辑器 | `app/dashboard/chapters/[id].tsx` | 2 天 |
| 封面上传 | `components/CoverPicker.tsx` | 0.5 天 |
| 标签选择 | `components/TagSelector.tsx` | 0.5 天 |

#### 直接复用

| 功能 | 来源 |
|------|------|
| 统计 API | `/api/dashboard/stats` ✅ |
| 小说 CRUD | `/api/admin/novels` ✅ |
| 章节 CRUD | `/api/admin/chapters` ✅ |
| 验证逻辑 | `novelCreateSchema`, `chapterCreateSchema` ✅ |
| 标签 API | `/api/tags/*` ✅ |

---

### 第七阶段: 上架准备 (2 周)

#### 必做清单

| 任务 | 说明 | 工作量 |
|------|------|--------|
| 性能优化 | 列表虚拟化、图片懒加载 | 2 天 |
| 错误监控 | Sentry 集成 | 0.5 天 |
| 分析埋点 | Firebase Analytics | 0.5 天 |
| 隐私政策 | 创建 `/privacy` 页面 | 0.5 天 |
| 服务条款 | 创建 `/terms` 页面 | 0.5 天 |
| 应用图标 | 各尺寸生成 | 0.5 天 |
| 启动画面 | Splash Screen | 0.5 天 |
| 截图制作 | 各页面截图 | 1 天 |
| iOS 审核 | TestFlight + 审核提交 | 2 天 |
| Android 审核 | 内测 + 审核提交 | 1 天 |

---

## 应用商店要求

### Google Play

| 要求 | 状态 | 操作 |
|------|------|------|
| 开发者账号 | ❌ | 注册 ($25 一次性) |
| 隐私政策 | ❌ | 创建页面 |
| 内容分级 | ❌ | 填写问卷 |
| 应用图标 | ✅ | `logo.png` 可用 |
| 截图 | ❌ | 制作 2+ 张 |
| 功能图片 | ❌ | 1024x500 banner |
| 目标 SDK | - | API 34+ |

### iOS App Store

| 要求 | 状态 | 操作 |
|------|------|------|
| 开发者账号 | ❌ | 注册 ($99/年) |
| 隐私政策 | ❌ | 与 GP 共用 |
| App Privacy | ❌ | 数据收集声明 |
| Sign in with Apple | ❌ | **必须实现** |
| 截图 | ❌ | 6.5" + 5.5" 各尺寸 |
| 应用图标 | ✅ | 需 1024x1024 无透明 |
| 年龄分级 | ❌ | 内容问卷 |

### 重要注意事项

1. **iOS 要求 Sign in with Apple** - 如果提供 Google 登录，必须同时提供 Apple 登录
2. **成人内容标记** - `EXPLICIT_18` 分级需在商店正确声明
3. **用户举报机制** - UGC 内容需要举报功能
4. **GDPR/CCPA** - 隐私政策需符合法规

---

## 时间线与成本

### 开发时间线

```
Week 1-2:   基础框架 + 认证
Week 3-5:   核心阅读功能
Week 6-7:   用户功能
Week 8-9:   互动功能
Week 10:    通知系统
Week 11-12: 作者功能
Week 13-14: 上架准备

总计: 14 周 (约 3.5 个月)
```

### 成本估算

| 项目 | 费用 |
|------|------|
| Apple Developer | $99/年 |
| Google Play Console | $25 (一次性) |
| Expo EAS Build | $0-99/月 |
| 服务器 | $0 增量 (已有) |
| 推送服务 | $0 (Firebase 免费层) |
| **首年总计** | **~$124-224** |

---

## 代码共享架构

### 推荐 Monorepo 结构

```
butternovel/
├── packages/
│   ├── shared/                    # 共享代码 ⭐
│   │   ├── api/
│   │   │   ├── client.ts          # API 客户端
│   │   │   ├── endpoints.ts       # 端点定义
│   │   │   └── types.ts           # 响应类型
│   │   ├── validation/
│   │   │   └── validators.ts      # ✅ Zod schemas
│   │   ├── utils/
│   │   │   ├── format.ts          # ✅ 格式化
│   │   │   └── constants.ts       # 常量
│   │   └── types/
│   │       └── prisma.ts          # ✅ Prisma 类型
│   │
│   ├── web/                       # 现有 Next.js
│   │   └── (现有代码)
│   │
│   └── mobile/                    # 新建 React Native
│       ├── app/                   # Expo Router 页面
│       ├── components/            # RN 组件
│       ├── hooks/                 # 自定义 Hooks
│       └── lib/                   # 移动端特有逻辑
│
├── package.json                   # Workspace 配置
└── turbo.json                     # Turborepo 配置
```

### 共享代码使用示例

```typescript
// mobile/app/novel/[slug].tsx
import { novelSchema } from '@butternovel/shared/validation'
import { formatDate, formatNumber } from '@butternovel/shared/utils'
import { apiClient } from '@butternovel/shared/api'

export default function NovelScreen() {
  const { data } = useQuery({
    queryKey: ['novel', slug],
    queryFn: () => apiClient.get(`/api/novels/${slug}`)
  })

  return (
    <View>
      <Text>{data.title}</Text>
      <Text>{formatDate(data.createdAt)}</Text>
      <Text>{formatNumber(data.viewCount)} views</Text>
    </View>
  )
}
```

---

## 快速启动命令

```bash
# 1. 创建 Expo 项目
npx create-expo-app@latest mobile --template tabs

# 2. 安装核心依赖
cd mobile
npx expo install @tanstack/react-query zustand
npx expo install react-hook-form @hookform/resolvers zod
npx expo install expo-secure-store expo-auth-session
npx expo install nativewind tailwindcss

# 3. 安装 UI 依赖
npx expo install react-native-reanimated react-native-gesture-handler
npx expo install lucide-react-native react-native-svg
npx expo install react-native-fast-image

# 4. 配置 NativeWind
# 参考: https://www.nativewind.dev/getting-started/expo-router

# 5. 启动开发
npx expo start
```

---

## 联系方式

如有问题，请联系开发团队或查阅:
- [Expo 文档](https://docs.expo.dev/)
- [React Native 文档](https://reactnative.dev/)
- [NativeWind 文档](https://www.nativewind.dev/)
